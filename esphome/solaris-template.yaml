# ============================================================================
# ESPHome Configuration for ROTEX Solaris RPS3/RPS4
# ============================================================================
esphome:
  name: esp-rotex-solaris-rps3 # Hostname of the ESP32 device
  friendly_name: "ROTEX Solaris RPS3" # Display name in Home Assistant

# ============================================================================
# HARDWARE CONFIGURATION
# ============================================================================
esp32:
  # M5Stack AtomS3-Lite (ESP32-S3) - adjust accordingly for other boards
  board: m5stack-atoms3
  variant: esp32s3
  framework:
    type: esp-idf

# ============================================================================
# LOGGING
# ============================================================================
logger:
  level: WARN
  baud_rate: 0  # Disable serial logging (network only for lower overhead)
  logs:
    uart: WARN  # Detailed UART communication logging

# ============================================================================
# API & OTA
# ============================================================================

# Enable API Communication
api:
  encryption:
    key: !secret solaris_api_encryption_key
  reboot_timeout: 0s  # Default 15min

# Enable OTA Updates
ota:
  - platform: esphome
    password: !secret solaris_ota_password

# ============================================================================
# WIFI & CONNECTIVITY
# ============================================================================
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  fast_connect: true  # Faster reconnection
  power_save_mode: none  # Prevent sleep mode issues
  domain: .iot.home.arpa # Change to your domain or remove if none defined
  use_address: xxx.xxx.xxx.xxx # Static IP if no DNS available

  # Enable fallback hotspot
  ap:
    ssid: "Solaris-RPS3 Fallback AP"
    password: !secret solaris_ap_fallback_password
  reboot_timeout: 0s  # Default 15min

# Enable captive portal for easy configuration
captive_portal:

# Set up Home Assistant time platform
time:
  - platform: homeassistant

# ============================================================================
# WEB INTERFACE
# ============================================================================
web_server:
  version: 3
  local: true  # Serves assets locally, no internet required
  include_internal: true
  auth:
    username: !secret solaris_web_server_username
    password: !secret solaris_web_server_password

# ============================================================================
# EXTERNAL COMPONENTS
# ============================================================================
external_components:
  - source: github://milkotodorov/daikin-rotex-solaris-rps@main
  # - source: # Local copy of the component for development
  #     type: local
  #     path: components
    components: [daikin_rotex_solaris]
    refresh: 0s

# ============================================================================
# UART CONFIGURATION (Solaris RPS3/4)
# ============================================================================
uart:
  id: uart_bus
  rx_pin: GPIO1
  baud_rate: 9600 # Lower baud rate for more reliable communication
  parity: NONE # Solaris RPS3/4 uses no parity

# ============================================================================
# SOLARIS COMPONENT
# ============================================================================
daikin_rotex_solaris:
  id: daikin_rotex_solaris_component
  uart_id: uart_bus
  language: de # See translations.py for supported languages. Default: de

  # Handbetrieb (Manual operation) (on/off)
  solaris_ha:
    id: solaris_ha
    web_server:
      sorting_weight: 9

  # Brennerkontakt (Burner contact) (on/off)
  solaris_bk:
    id: solaris_bk
    web_server:
      sorting_weight: 10     
  
  # Pumpe (P1) (0-100 %)
  solaris_p1:
    id: solaris_p1
    filters:
      - throttle: 10s
    web_server:
      sorting_weight: 7

  # Comment out the booster pump sensor for ROTEX Solaris RPS4, as it has no such pump
  # Boosterpumpe (Booster pump) (on/off)
  solaris_p2:
    id: solaris_p2
    web_server:
      sorting_weight: 8

  # Kollektortemperatur (Collector temperature) (-55-250 °C)
  solaris_tk:
    id: solaris_tk
    filters:
      - throttle: 10s
    web_server:
      sorting_weight: 1

  # Rücklauftemperatur (Return temperature) (0-100 °C)
  solaris_tr:
    id: solaris_tr
    filters:
      - throttle: 30s
    web_server:
      sorting_weight: 2

  # Speichertemperatur (Storage temperature) (0-100 °C)
  solaris_ts:
    id: solaris_ts
    filters:
      - throttle: 30s
    web_server:
      sorting_weight: 3

  # Vorlauftemperatur (Flow temperature) (0-100 °C)
  solaris_tv:
    id: solaris_tv
    filters:
      - throttle: 10s
    web_server:
      sorting_weight: 4

  # Durchfluss (Flow rate) (0-20 l/min)
  solaris_df:
    id: solaris_df
    filters:
      - delta: 0.2
      - throttle: 10s
    web_server:
      sorting_weight: 5

  # Error state sensor:
  #   ' ': no error
  #   'K': Kollektortemperatu,
  #   'R': Rücklauftemperatur
  #   'S': Speichertemperatur
  #   'D': Durchfluss
  #   'V': Vorlauftemperatur
  #   'G': A/D-Wandler-Fehler / Versorgungsspannungsfehler / Referenzspannungsfehler
  #   'F/W': Minimaldurchfluss V1 wurde in der Startphase nach Ablauf der \"Zeit P2\" nicht erreicht
  solaris_err:
    id: solaris_err
    web_server:
      sorting_weight: 11

  # Leistung (Power) kW
  solaris_pwr:
    id: solaris_pwr
    filters:
      - throttle: 10s
    web_server:
      sorting_weight: 6

# ============================================================================
# DEBUGGING & MONITORING
# ============================================================================
debug:
  update_interval: 60s

# Built-in Sensors (ESP Health Monitoring)
sensor:
  - platform: internal_temperature
    name: "ESP Internal Temperature"
    icon: "mdi:thermometer"
    update_interval: 900s
    web_server:
      sorting_weight: 60

  - platform: uptime
    name: "Boot Timestamp"
    icon: "mdi:timer-check-outline"
    id: boot_timestamp
    type: timestamp
    web_server:
      sorting_weight: 61

  - platform: debug
    free:
      name: "Heap Free (bytes)"
      icon: mdi:counter
      web_server:
        sorting_weight: 63
    block:
      name: "Heap Max Block (bytes)"
      icon: mdi:counter
      web_server:
        sorting_weight: 64

  - platform: wifi_signal
    name: "WiFi Signal Strength (dBm)"
    internal: true
    icon: "mdi:signal-cellular-2"
    update_interval: 900s
    web_server:
      sorting_weight: 62

# Text sensors (System Info)
text_sensor:
  - platform: debug
    # Reports ESP chip model, MAC address, and ESPHome version
    device:
      name: "Device Info"
      internal: true  # Only for WebUI, not exposed to the HA
      web_server:
        sorting_weight: 70
    reset_reason:
      name: "Reset Reason"
      icon: "mdi:restart"
      web_server:
        sorting_weight: 69

  - platform: wifi_info
    ip_address:
      name: "IP Address"
      icon: "mdi:ip"
      internal: true
      web_server:
        sorting_weight: 67
    ssid:
      name: "Connected SSID"
      internal: true
      icon: "mdi:wifi"
      web_server:
        sorting_weight: 66

# Restart Button
button:
  - platform: restart
    name: "ESP Restart"
    icon: "mdi:restart"
    entity_category: diagnostic
    web_server:
        sorting_weight: 99
